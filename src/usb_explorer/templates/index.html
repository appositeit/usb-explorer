<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USB Explorer</title>
    <link rel="icon" type="image/png" href="/static/img/icon.png">

    <!-- D3.js for tree visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Lucide icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body class="dark-mode">
    <header>
        <h1>
            <img src="/static/img/icon.png" alt="USB Explorer" class="header-icon">
            USB Explorer
        </h1>
        <div class="header-controls">
            <div class="search-container">
                <i data-lucide="search" class="search-icon"></i>
                <input type="text" id="device-search" placeholder="Search devices..." title="Search by name, vendor, product, path...">
                <button id="search-clear" class="search-clear hidden" title="Clear search">
                    <i data-lucide="x"></i>
                </button>
                <div id="search-results" class="search-results hidden"></div>
            </div>
            <button id="refresh-btn" title="Refresh device tree">
                <i data-lucide="refresh-cw"></i>
                Refresh
            </button>
            <button id="sound-toggle" title="Toggle sounds">
                <i data-lucide="volume-2"></i>
            </button>
            <button id="theme-toggle" title="Toggle dark/light mode">
                <i data-lucide="moon"></i>
            </button>
            <span id="connection-status" class="status-disconnected">
                <i data-lucide="wifi-off"></i>
                Disconnected
            </span>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- Left Column: Info + Log stacked -->
            <div class="left-column">
                <!-- Info Panel -->
                <section id="info-panel" class="panel">
                    <div class="panel-header">
                        <h2><i data-lucide="info"></i> Device Info</h2>
                    </div>
                    <div id="info-content">
                        <p class="placeholder">Click a device to view details</p>
                    </div>
                </section>

                <!-- Event Log Panel -->
                <section id="log-panel" class="panel">
                    <div class="panel-header">
                        <h2><i data-lucide="scroll-text"></i> Event Log</h2>
                        <div class="log-controls">
                            <div class="filter-dropdown">
                                <button id="filter-btn" title="Filter events">
                                    <i data-lucide="filter"></i>
                                </button>
                                <div id="filter-menu" class="dropdown-menu hidden">
                                    <label><input type="checkbox" id="filter-add" checked> Device Added</label>
                                    <label><input type="checkbox" id="filter-remove" checked> Device Removed</label>
                                    <label><input type="checkbox" id="filter-error" checked> Errors</label>
                                </div>
                            </div>
                            <button id="clear-log-btn" title="Clear log">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </div>
                    </div>
                    <div id="log-content">
                        <div class="log-placeholder">Waiting for events...</div>
                    </div>
                </section>
            </div>

            <!-- Device Tree Panel -->
            <section id="tree-panel" class="panel">
                <div class="panel-header">
                    <h2><i data-lucide="git-branch"></i> Device Tree</h2>
                    <div class="spacing-control">
                        <label for="spacing-slider" title="Adjust vertical spacing">
                            <i data-lucide="move-vertical"></i>
                        </label>
                        <input type="range" id="spacing-slider" min="5" max="60" value="42" title="Node spacing">
                        <span id="spacing-value">42</span>
                    </div>
                </div>
                <div id="tree-container">
                    <svg id="tree-svg"></svg>
                </div>
            </section>
        </div>
    </main>

    <!-- Audio elements for notifications -->
    <audio id="sound-connect" preload="auto">
        <source src="/static/sounds/connect.mp3" type="audio/mpeg">
    </audio>
    <audio id="sound-disconnect" preload="auto">
        <source src="/static/sounds/disconnect.mp3" type="audio/mpeg">
    </audio>

    <!-- Device name edit modal -->
    <div id="name-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Set Custom Name</h3>
            <p id="modal-device-info"></p>
            <input type="text" id="name-input" placeholder="Enter custom name">
            <div class="modal-buttons">
                <button id="name-save-btn" class="primary">Save</button>
                <button id="name-cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Hub label edit modal -->
    <div id="hub-label-modal" class="modal hidden">
        <div class="modal-content modal-wide">
            <h3>Hub Settings</h3>
            <p id="hub-label-info"></p>

            <!-- Group name section -->
            <div class="modal-section" id="hub-label-section">
                <label for="hub-label-input">Group Name:</label>
                <input type="text" id="hub-label-input" placeholder="Enter name (e.g. DOCK, MONITOR)" maxlength="20">
                <p class="hint">Name to identify this hub group in the tree</p>
            </div>

            <!-- Detect group devices section -->
            <div class="modal-section" id="hub-learn-section">
                <label>Detect Group Devices:</label>
                <p class="hint">Physically disconnect/reconnect to detect which hubs are in the same device</p>

                <!-- Important guidance -->
                <div id="hub-learn-guidance" class="guidance-box">
                    <p><strong>⚠️ Important:</strong> If this hub has other hubs connected <em>downstream</em> (plugged into it), identify those <strong>first</strong> before this one. Otherwise downstream hubs will be incorrectly included in this group.</p>
                </div>

                <!-- Start detection button -->
                <div id="hub-learn-status">
                    <button id="hub-learn-btn" class="secondary">
                        <i data-lucide="unplug"></i> Start Detection
                    </button>
                </div>

                <!-- Detection in progress -->
                <div id="hub-learn-progress" class="hidden">
                    <div class="detection-instructions">
                        <p><strong>Detection in progress...</strong></p>
                        <ol>
                            <li>Physically <strong>unplug</strong> this USB hub/dock</li>
                            <li>Wait 1-2 seconds</li>
                            <li>Plug it back in</li>
                            <li>Click "Stop Detection" below</li>
                        </ol>
                    </div>
                    <button id="hub-learn-stop-btn" class="primary">
                        <i data-lucide="check"></i> Stop Detection
                    </button>
                    <button id="hub-learn-cancel-btn" class="secondary">
                        Cancel
                    </button>
                </div>

                <!-- Detection results -->
                <div id="hub-learn-result" class="hidden">
                    <div id="hub-learn-devices"></div>
                </div>
            </div>

            <div class="modal-buttons">
                <button id="hub-label-save-btn" class="primary">Save Group Name</button>
                <button id="hub-label-cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Learned group edit modal -->
    <div id="learned-group-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Edit Physical Group</h3>
            <p id="learned-group-info"></p>
            <div id="learned-group-members"></div>
            <div class="form-group">
                <label for="learned-group-name">Group Name:</label>
                <input type="text" id="learned-group-name" placeholder="e.g., USB Dock, Monitor Hub">
            </div>
            <div class="modal-buttons">
                <button id="learned-group-save-btn" class="primary">Save</button>
                <button id="learned-group-delete-btn" class="danger">Delete Group</button>
                <button id="learned-group-cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Sound settings modal -->
    <div id="sound-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Sound Settings</h3>
            <div class="sound-settings">
                <label class="sound-option">
                    <input type="checkbox" id="sound-enabled" checked>
                    <span>Enable sounds</span>
                </label>
                <div class="sound-sub-options">
                    <label class="sound-option">
                        <input type="checkbox" id="sound-connect-enabled" checked>
                        <span>Device connected</span>
                    </label>
                    <label class="sound-option">
                        <input type="checkbox" id="sound-disconnect-enabled" checked>
                        <span>Device disconnected</span>
                    </label>
                    <label class="sound-option">
                        <input type="checkbox" id="sound-error-enabled" checked>
                        <span>Errors</span>
                    </label>
                </div>
            </div>
            <div class="modal-buttons">
                <button id="sound-close-btn" class="primary">Close</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/static/js/websocket.js"></script>
    <script src="/static/js/audio.js"></script>
    <script src="/static/js/info-panel.js"></script>
    <script src="/static/js/tree.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>
