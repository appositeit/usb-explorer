#!/bin/bash
# Restart USB Explorer server

# Load common configuration
source "$(dirname "${BASH_SOURCE[0]}")/common.sh"

echo "Restarting USB Explorer..."

# Stop existing server
"$SCRIPT_DIR/stop_usb_debug"

# Wait a moment for clean shutdown
sleep 1

# Verify it's stopped
if [ -f "$PID_FILE" ]; then
    OLD_PID=$(cat "$PID_FILE")
    if kill -0 "$OLD_PID" 2>/dev/null; then
        echo "Force killing PID $OLD_PID..."
        kill -9 "$OLD_PID" 2>/dev/null
        sleep 1
    fi
    rm -f "$PID_FILE"
fi

# Also check for any orphan processes
for pid in $(pgrep -f "usb_explorer.main" 2>/dev/null); do
    echo "Killing orphan process $pid..."
    kill -9 "$pid" 2>/dev/null
done

sleep 1

# Start the server
"$SCRIPT_DIR/start_usb_debug"
