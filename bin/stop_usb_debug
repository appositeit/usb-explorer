#!/bin/bash
# Stop USB Explorer server

# Load common configuration
source "$(dirname "${BASH_SOURCE[0]}")/common.sh"

echo "Stopping USB Explorer..."

# Try API shutdown
if curl -s -X POST "http://localhost:$USB_DEBUG_PORT/api/shutdown" > /dev/null 2>&1; then
    echo "Shutdown request sent"
    sleep 2
fi

# Check PID file
if [ -f "$PID_FILE" ]; then
    PID=$(cat "$PID_FILE")

    if kill -0 "$PID" 2>/dev/null; then
        echo "Stopping process $PID..."
        kill "$PID" 2>/dev/null

        # Wait up to 5 seconds
        for i in {1..10}; do
            if ! kill -0 "$PID" 2>/dev/null; then
                break
            fi
            sleep 0.5
        done

        # Force kill if still running
        if kill -0 "$PID" 2>/dev/null; then
            echo "Force killing process $PID..."
            kill -9 "$PID" 2>/dev/null
        fi
    fi

    rm -f "$PID_FILE"
    echo "USB Explorer stopped"
else
    # Try to find and kill by process name
    pkill -f "usb_explorer.main" 2>/dev/null && echo "Killed process" || echo "No running instance found"
fi
